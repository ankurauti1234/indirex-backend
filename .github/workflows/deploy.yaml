name: Deploy to EC2 via Jump Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh

          # Save keys
          echo "${{ secrets.SSH_JUMP_KEY }}" > ~/.ssh/jump_key
          echo "${{ secrets.SSH_TARGET_KEY }}" > ~/.ssh/target_key
          chmod 600 ~/.ssh/jump_key ~/.ssh/target_key

          # Add known hosts
          ssh-keyscan ${{ secrets.JUMP_HOST }} >> ~/.ssh/known_hosts
          ssh-keyscan ${{ secrets.TARGET_HOST }} >> ~/.ssh/known_hosts

          # Create SSH config
          cat <<EOF > ~/.ssh/config
          Host jump
            HostName ${{ secrets.JUMP_HOST }}
            User ${{ secrets.JUMP_USER }}
            IdentityFile ~/.ssh/jump_key

          Host target
            HostName ${{ secrets.TARGET_HOST }}
            User ${{ secrets.TARGET_USER }}
            IdentityFile ~/.ssh/target_key
            ProxyJump jump
          EOF

          chmod 600 ~/.ssh/config

      - name: Upload code using rsync via jump server
        run: |
          rsync -avz \
            --exclude='.git' \
            -e "ssh -F ~/.ssh/config" \
            ./ target:${{ secrets.TARGET_DIR }}

      - name: Execute deploy script
        run: |
          ssh -F ~/.ssh/config target "bash /var/www/deploy.sh"
